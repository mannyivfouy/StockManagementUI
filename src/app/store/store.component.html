<div class="store-root d-flex flex-column vh-100">
  <!-- Header -->
  <header
    class="header d-flex align-items-center justify-content-between px-4 py-3 border-bottom flex-shrink-0"
  >
    <h2 class="mb-0 fw-bold">Online Store</h2>

    <!-- Search bar -->
    <div class="input-group w-50">
      <input
        type="text"
        class="form-control"
        placeholder="Search products..."
        [(ngModel)]="searchTerm"
        (keyup.enter)="onSearch()"
      />
      <button class="btn btn-primary" type="button" (click)="onSearch()">
        <i class="bi bi-search"></i>
      </button>
    </div>

    <!-- Cart button -->
    <button class="btn btn-primary position-relative" (click)="toggleCart()">
      <i class="bi bi-cart3"></i>
      <span class="ms-1 d-none d-md-inline">Cart</span>
      <span
        *ngIf="totalQuantity() > 0"
        class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle"
        >{{ totalQuantity() }}</span
      >
    </button>
  </header>

  <!-- Categories -->
  <div class="categories px-4 py-3 flex-shrink-0 border-bottom">
    <button
      class="btn me-2 mb-2"
      [ngClass]="
        selectedCategory === null ? 'btn-primary' : 'btn-outline-primary'
      "
      (click)="clearCategoryFilter()"
    >
      All
    </button>
    <button
      class="btn me-2 mb-2"
      *ngFor="let c of categories"
      [ngClass]="selectedCategory === c ? 'btn-primary' : 'btn-outline-primary'"
      (click)="filterByCategory(c)"
    >
      {{ c }}
    </button>
  </div>

  <!-- Products scrollable -->
  <div class="products-container flex-grow-1 overflow-auto px-4 py-3">
    <div class="row g-3">
      <div
        class="col-6 col-md-4 col-lg-3"
        *ngFor="let product of paginatedProducts"
      >
        <div class="card h-100 position-relative product-card shadow-sm">
          <img
            [src]="getProductImage(product)"
            class="card-img-top"
            alt="{{ product.productName }}"
            style="height: 150px; object-fit: contain"
          />
          <div class="card-body d-flex flex-column py-2">
            <h6 class="card-title mb-1">{{ product.productName }}</h6>
            <small class="text-muted mb-1">{{
              product.categoryName || "No Category"
            }}</small>
            <p class="card-text text-truncate mb-2">
              {{ product.description || "No description" }}
            </p>
            <div
              class="mt-auto d-flex justify-content-between align-items-center"
            >
              <span class="fw-bold"
                >$ {{ product.price | number : "1.2-2" }}</span
              >
              <button
                class="btn btn-sm btn-primary"
                (click)="addToCart(product)"
              >
                Add
                <span *ngIf="isInCart(product)" class="red-dot"></span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination fixed -->
  <div
    class="pagination-fixed d-flex justify-content-center align-items-center py-2 border-top flex-shrink-0"
  >
    <button
      class="btn btn-outline-primary me-3"
      [disabled]="currentPage === 1"
      (click)="prevPage()"
    >
      <i class="bi bi-chevron-left"></i> Prev
    </button>
    <span>Page {{ currentPage }} of {{ totalPages }}</span>
    <button
      class="btn btn-outline-primary ms-3"
      [disabled]="currentPage === totalPages"
      (click)="nextPage()"
    >
      Next <i class="bi bi-chevron-right"></i>
    </button>
  </div>

  <!-- Cart drawer -->
  <div class="cart-backdrop" *ngIf="showCart" (click)="toggleCart()"></div>
  <aside
    class="cart-drawer"
    [class.open]="showCart"
    (click)="$event.stopPropagation()"
  >
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Your Cart</h5>
      <button class="btn btn-sm btn-danger" (click)="toggleCart()">
        <i class="bi bi-x-lg text-white"></i>
      </button>
    </div>

    

    <!-- Scrollable cart items -->
    <div class="cart-items-scroll" *ngIf="cartItems.length > 0">
      <div
        *ngFor="let ci of cartItems"
        class="cart-item d-flex gap-3 align-items-center py-2 border-bottom"
      >
        <img
          [src]="getProductImage(ci.product)"
          style="
            width: 64px;
            height: 64px;
            object-fit: cover;
            border-radius: 6px;
          "
        />
        <div class="flex-grow-1">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-bold">{{ ci.product.productName }}</div>
              <small class="text-muted">{{
                ci.product.categoryName || "No Category"
              }}</small>
            </div>
            <div class="text-end">
              <div class="fw-semibold">
                $ {{ ci.product.price | number : "1.2-2" }}
              </div>
              <small class="text-muted">unit</small>
            </div>
          </div>
          <div class="d-flex align-items-center gap-2 mt-2">
            <div class="input-group input-group-sm w-auto">
              <button
                class="btn btn-outline-secondary"
                (click)="decreaseQty(ci)"
              >
                -
              </button>
              <input
                class="form-control text-center"
                [value]="ci.qty"
                readonly
                style="width: 48px"
              />
              <button
                class="btn btn-outline-secondary"
                (click)="increaseQty(ci)"
              >
                +
              </button>
            </div>
            <button
              class="btn btn-sm btn-outline-danger ms-2"
              (click)="removeItem(ci)"
            >
              Remove
            </button>
            <div class="ms-auto fw-bold">
              $ {{ ci.product.price * ci.qty | number : "1.2-2" }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      *ngIf="cartItems.length === 0"
      class="d-flex align-items-center justify-content-center"
    >      
      <p>Your Cart is Empty</p>
    </div>

    <!-- Footer with subtotal and buttons -->
    <div class="cart-footer" *ngIf="cartItems.length > 0">
      <div class="d-flex justify-content-between">
        <div>Subtotal</div>
        <div class="fw-bold">$ {{ subtotal() | number : "1.2-2" }}</div>
      </div>
      <hr />
      <div class="d-flex justify-content-between fs-5 fw-bold">
        <div>Total</div>
        <div>$ {{ total() | number : "1.2-2" }}</div>
      </div>
      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-primary flex-grow-1" (click)="checkout()">
          Checkout
        </button>
        <button class="btn btn-outline-danger" (click)="clearCart()">
          Clear
        </button>
      </div>
    </div>
  </aside>

  <div
    class="popup-backdrop"
    *ngIf="showConfirmPopup"
    (click)="closeConfirm()"
  ></div>

  <!--! -->

  <div
    class="popup-card"
    *ngIf="showConfirmPopup"
    (click)="$event.stopPropagation()"
  >
    <h5 class="mb-2">Confirm Checkout</h5>
    <p class="text-muted small">
      Click Confirm to finish the order or Print to print a receipt.
    </p>

    <div class="d-flex gap-2 justify-content-end">
      <button class="btn btn-outline-secondary" (click)="closeConfirm()">
        Cancel
      </button>
      <button class="btn btn-success" (click)="confirmCheckout()">
        Confirm
      </button>
      <button class="btn btn-primary" (click)="printReceipt()">Print</button>
    </div>
  </div>
</div>
